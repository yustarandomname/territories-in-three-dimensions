import{S as j,i as K,s as L,k as G,q as g,a as U,e as q,l as R,m as S,r as B,h as f,c as T,n as O,b as d,G as w,u as W,H as z,o as Y,L as I,J as C,K as H,M as Q}from"../chunks/index.2ecf17a4.js";import{s as V,H as X}from"../chunks/gpuStore.3315e7be.js";import{U as D}from"../chunks/computeShader3d.ebc538df.js";function Z(c){let r,a,i,e,o,u,h,m,p,t,l=JSON.stringify(c[2])+"",P,n,E;return{c(){r=G("p"),a=g("Nice we are loaded"),i=U(),e=G("input"),o=U(),u=G("button"),h=g("iterate "),m=g(c[3]),p=g(" times"),t=U(),P=g(l),this.h()},l(s){r=R(s,"P",{});var _=S(r);a=B(_,"Nice we are loaded"),_.forEach(f),i=T(s),e=R(s,"INPUT",{type:!0}),o=T(s),u=R(s,"BUTTON",{});var k=S(u);h=B(k,"iterate "),m=B(k,c[3]),p=B(k," times"),k.forEach(f),t=T(s),P=B(s,l),this.h()},h(){O(e,"type","number")},m(s,_){d(s,r,_),w(r,a),d(s,i,_),d(s,e,_),C(e,c[3]),d(s,o,_),d(s,u,_),w(u,h),w(u,m),w(u,p),d(s,t,_),d(s,P,_),n||(E=[H(e,"input",c[6]),H(u,"click",c[7])],n=!0)},p(s,_){_&8&&I(e.value)!==s[3]&&C(e,s[3]),_&8&&W(m,s[3]),_&4&&l!==(l=JSON.stringify(s[2])+"")&&W(P,l)},d(s){s&&f(r),s&&f(i),s&&f(e),s&&f(o),s&&f(u),s&&f(t),s&&f(P),n=!1,Q(E)}}}function x(c){let r,a;return{c(){r=G("p"),a=g("We are loading")},l(i){r=R(i,"P",{});var e=S(r);a=B(e,"We are loading"),e.forEach(f)},m(i,e){d(i,r,e),w(r,a)},p:z,d(i){i&&f(r)}}}function $(c){let r,a,i;return{c(){r=G("p"),a=g("Something went wrong: "),i=g(c[0])},l(e){r=R(e,"P",{});var o=S(r);a=B(o,"Something went wrong: "),i=B(o,c[0]),o.forEach(f)},m(e,o){d(e,r,o),w(r,a),w(r,i)},p(e,o){o&1&&W(i,e[0])},d(e){e&&f(r)}}}function ee(c){let r,a,i=c[4].iterations+"",e,o,u;function h(t,l){return t[0]?$:t[1]?x:Z}let m=h(c),p=m(c);return{c(){r=G("h1"),a=g("Iterations run: "),e=g(i),o=U(),p.c(),u=q(),this.h()},l(t){r=R(t,"H1",{class:!0});var l=S(r);a=B(l,"Iterations run: "),e=B(l,i),l.forEach(f),o=T(t),p.l(t),u=q(),this.h()},h(){O(r,"class","text-3xl")},m(t,l){d(t,r,l),w(r,a),w(r,e),d(t,o,l),p.m(t,l),d(t,u,l)},p(t,[l]){l&16&&i!==(i=t[4].iterations+"")&&W(e,i),m===(m=h(t))&&p?p.p(t,l):(p.d(1),p=m(t),p&&(p.c(),p.m(u.parentNode,u)))},i:z,o:z,d(t){t&&f(r),t&&f(o),p.d(t),t&&f(u)}}}let F=625e4;function te(c,r,a){let i,e,o,u,h,m=!0,p=[],t=1e4,l=new D(50,F,3,123),P;const n={lambda:.5,gamma:.5,beta:4/3*1e-5,size:l.size,iterations:0,total_agents:F,seed:123};Y(async()=>{a(1,m=!0);const y=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice();if(!y){console.log("need a browser that supports WebGPU"),a(0,h="need a browser that supports WebGPU this demo only works in Chrome version 114+ ");return}i=y;const v=new Float32Array([n.lambda,n.gamma,n.beta,n.size,n.iterations,n.total_agents]),A=new Float32Array(l.to_f32_buffer()),M=await V(y,{hyperparamsArray:v,universeArray:A},X.fromObject(n));e=M.pipelines,u=M.storageBuffers,o=M.outputBuffers,a(0,h=""),a(1,m=!1)});async function E(k){if(!e||m||!i)return;a(1,m=!0);const y=i.createCommandEncoder(),v=Math.ceil(Math.pow(n.size,3)/100);console.time(`Time to iterate: ${t}`);for(let N=0;N<k;N++){const b=y.beginComputePass();b.setPipeline(e.update_graffiti_and_push_strength.pipeline),b.setBindGroup(0,e.update_graffiti_and_push_strength.bindGroups[n.iterations%2]),b.dispatchWorkgroups(v,1,1),b.setPipeline(e.move_agents_out.pipeline),b.setBindGroup(0,e.move_agents_out.bindGroups[n.iterations%2]),b.dispatchWorkgroups(v,1,1),b.setPipeline(e.move_agents_in.pipeline),b.setBindGroup(0,e.move_agents_in.bindGroups[n.iterations%2]),b.dispatchWorkgroups(v,1,1),a(4,n.iterations++,n),b.end()}const A=y.beginComputePass();A.setPipeline(e.calculate_order_param.pipeline),A.setBindGroup(0,e.calculate_order_param.bindGroups[n.iterations%2]),A.dispatchWorkgroups(v,1,1),A.end(),y.copyBufferToBuffer(u.cellStateStorage[(n.iterations+1)%2],0,o.resultBuffer,0,o.resultBuffer.size),y.copyBufferToBuffer(u.orderBuffer,0,o.orderResultBuffer,0,o.orderResultBuffer.size),i.queue.submit([y.finish()]),console.timeEnd(`Time to iterate: ${t}`),await o.resultBuffer.mapAsync(GPUMapMode.READ);const M=new Float32Array(o.resultBuffer.getMappedRange().slice(0));o.resultBuffer.unmap(),P=D.from_result(M,n.size,3,123),console.log("output",P.nodes.slice(0,10)),await o.orderResultBuffer.mapAsync(GPUMapMode.READ);const J=new Float32Array(o.orderResultBuffer.getMappedRange().slice(0));o.orderResultBuffer.unmap(),a(2,p=[...p,{iteration:n.iterations,orderParam:J[0]}]),a(1,m=!1)}function s(){t=I(this.value),a(3,t)}return[h,m,p,t,n,E,s,async()=>{console.time(`Time to iterate total: ${t}`),await E(t),console.timeEnd(`Time to iterate total: ${t}`)}]}class ie extends j{constructor(r){super(),K(this,r,te,ee,L,{})}}export{ie as component};
